pipeline {
    agent any
    
    environment {
        APP_NAME = 'fast-react-pizza'
        DOCKER_IMAGE = "${APP_NAME}-dev-${env.BUILD_NUMBER}"
        CONTAINER_NAME = "${APP_NAME}-dev-${env.BUILD_NUMBER}"
        PORT = '3002'
    }
    
    stages {
        stage('๐ฅ Checkout') {
            steps {
                echo '========== STAGE 1: CHECKOUT =========='
                checkout scm
                bat '''
                    echo โ Checked out DEV branch
                    git branch
                    git log -1 --oneline
                '''
            }
        }
        
        stage('โ๏ธ Setup') {
            steps {
                echo '========== STAGE 2: SETUP =========='
                bat '''
                    node --version
                    npm --version
                    docker --version
                    git --version
                '''
            }
        }
        
        stage('๐จ Build Application') {
            steps {
                echo '========== STAGE 3: BUILD APPLICATION =========='
                bat '''
                    echo ๐ฆ Installing dependencies...
                    call npm ci
                    echo ๐ Running linter...
                    call npm run lint || echo Linter warnings ignored
                    echo โ Build complete
                '''
            }
        }
        
        stage('๐ณ Docker Build') {
            steps {
                echo '========== STAGE 4: DOCKER BUILD =========='
                bat '''
                    echo ๐ณ Building image: %DOCKER_IMAGE%
                    docker build -t %DOCKER_IMAGE% .
                    echo โ Docker image built
                    docker images | findstr %APP_NAME%
                '''
            }
        }
        
        stage('๐ Run Container') {
            steps {
                echo '========== STAGE 5: RUN CONTAINER =========='
                bat '''
                    docker rm -f %CONTAINER_NAME% 2>nul
                    docker run -d --name %CONTAINER_NAME% -p %PORT%:80 -e APP_VERSION=dev-%BUILD_NUMBER% %DOCKER_IMAGE%
                    timeout /t 8 /nobreak
                    docker ps | findstr %CONTAINER_NAME%
                '''
            }
        }
        
        stage('๐ฅ Smoke Tests') {
            steps {
                echo '========== STAGE 6: SMOKE TESTS =========='
                bat '''
                    set APP_URL=http://localhost:%PORT%
                    call npm run smoke
                '''
            }
        }
        
        stage('๐ฆ Archive Artifacts') {
            steps {
                echo '========== STAGE 7: ARCHIVE ARTIFACTS =========='
                bat '''
                    if not exist artifacts mkdir artifacts
                    echo === DEV BUILD INFO === > artifacts\\build-info.txt
                    echo Build Number: %BUILD_NUMBER% >> artifacts\\build-info.txt
                    echo Branch: dev >> artifacts\\build-info.txt
                    echo Status: PASSED >> artifacts\\build-info.txt
                    echo Date: %date% %time% >> artifacts\\build-info.txt
                    echo Image: %DOCKER_IMAGE% >> artifacts\\build-info.txt
                    docker logs %CONTAINER_NAME% > artifacts\\container-logs.txt 2>&1
                    docker inspect %DOCKER_IMAGE% > artifacts\\image-info.json
                '''
                archiveArtifacts artifacts: 'artifacts/*', allowEmptyArchive: false
            }
        }
        
        stage('๐งน Cleanup') {
            steps {
                echo '========== STAGE 8: CLEANUP =========='
                bat '''
                    docker stop %CONTAINER_NAME% 2>nul
                    docker rm %CONTAINER_NAME% 2>nul
                    docker rmi %DOCKER_IMAGE% 2>nul
                '''
            }
        }
    }
    
    post {
        success {
            echo 'โโโ DEV PIPELINE PASSED โโโ'
        }
        failure {
            echo 'โโโ DEV PIPELINE FAILED โโโ'
        }
        always {
            cleanWs()
        }
    }
}