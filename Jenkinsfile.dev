pipeline {
    agent any
    
    stages {
        stage('üì• Checkout') {
            steps {
                echo '========== STAGE 1: CHECKOUT =========='
                checkout scm
                bat '''
                    echo ‚úÖ Checked out DEV branch
                    git branch
                    git log -1 --oneline
                '''
            }
        }
        
        stage('‚öôÔ∏è Setup') {
            steps {
                echo '========== STAGE 2: SETUP =========='
                bat '''
                    node --version
                    npm --version
                '''
            }
        }
        
        stage('üî® Build Application') {
            steps {
                echo '========== STAGE 3: BUILD APPLICATION =========='
                bat '''
                    echo üì¶ Installing dependencies... 
                    call npm ci
                    
                    echo ‚úÖ Dependencies installed
                '''
            }
        }
        
        stage('üê≥ Docker Build') {
            steps {
                echo '========== STAGE 4: DOCKER BUILD =========='
                bat '''
                    echo üê≥ Building Docker image: fast-react-pizza-dev-%BUILD_NUMBER%
                    docker build -t fast-react-pizza-dev:%BUILD_NUMBER% .
                    
                    echo ‚úÖ Image built
                    docker images | findstr fast-react-pizza
                '''
            }
        }
        
        stage('üöÄ Run Container') {
            steps {
                echo '========== STAGE 5: RUN CONTAINER =========='
                bat '''
                    REM Cleanup old containers
                    docker rm -f fast-react-pizza-dev-%BUILD_NUMBER% 2>nul || echo No existing container
                    
                    REM Start new container
                    docker run -d --name fast-react-pizza-dev-%BUILD_NUMBER% -p 3001:80 fast-react-pizza-dev:%BUILD_NUMBER%
                    
                    REM Wait 10 seconds
                    ping 127.0.0.1 -n 11 >nul
                    
                    REM Verify container
                    docker ps | findstr fast-react-pizza-dev
                '''
            }
        }
        
        stage('üî• Smoke Tests') {
            steps {
                echo '========== STAGE 6: SMOKE TESTS =========='
                bat '''
                    echo üß™ Testing application on http://localhost:3001
                    curl -f http://localhost:3001 || exit /b 1
                    
                    echo ‚úÖ Smoke test PASSED
                '''
            }
        }
        
        stage('üì¶ Archive Artifacts') {
            steps {
                echo '========== STAGE 7: ARCHIVE ARTIFACTS =========='
                bat '''
                    echo Creating build report...
                    echo Dev Build Report > dev-build-report.log
                    echo Build Number: %BUILD_NUMBER% >> dev-build-report.log
                    echo Docker Image: fast-react-pizza-dev:%BUILD_NUMBER% >> dev-build-report.log
                    echo Status: Success >> dev-build-report.log
                '''
                archiveArtifacts artifacts: '*. log', allowEmptyArchive: true
            }
        }
        
        stage('üßπ Cleanup') {
            steps {
                echo '========== STAGE 8: CLEANUP =========='
                bat '''
                    echo üßπ Cleaning up... 
                    docker stop fast-react-pizza-dev-%BUILD_NUMBER% || echo Container already stopped
                    docker rm fast-react-pizza-dev-%BUILD_NUMBER% || echo Container already removed
                '''
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ‚úÖ‚úÖ DEV PIPELINE PASSED ‚úÖ‚úÖ‚úÖ'
        }
        failure {
            echo '‚ùå‚ùå‚ùå DEV PIPELINE FAILED ‚ùå‚ùå‚ùå'
        }
        always {
            cleanWs()
        }
    }
}