pipeline {
    agent any
    
    environment {
        VERSION = 'v1.0.0'
    }
    
    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo '========== STAGE 1: CHECKOUT =========='
                checkout scm
                bat '''
                    echo âœ… Checked out tag: v1.0.0
                    git describe --tags || echo No tag
                    git log -1 --oneline
                '''
            }
        }
        
        stage('âš™ï¸ Setup') {
            steps {
                echo '========== STAGE 2: SETUP =========='
                bat '''
                    echo ğŸ·ï¸  Release Version: v1.0.0
                    node --version
                    npm --version
                '''
            }
        }
        
        stage('ğŸ”¨ Build') {
            steps {
                echo '========== STAGE 3: BUILD =========='
                bat '''
                    echo ğŸ“¦ Installing dependencies...
                    call npm ci
                    
                    echo âœ… Dependencies installed
                '''
            }
        }
        
        stage('ğŸ³ Docker Build') {
            steps {
                echo '========== STAGE 4: DOCKER BUILD =========='
                bat '''
                    echo ğŸ³ Building release image: fast-react-pizza-v1.0.0
                    docker build -t fast-react-pizza:v1.0.0 -t fast-react-pizza:latest . 
                    
                    echo âœ… Release image built
                    docker images | findstr fast-react-pizza
                '''
            }
        }
        
        stage('ğŸš€ Run') {
            steps {
                echo '========== STAGE 5: RUN CONTAINER =========='
                bat '''
                    REM Cleanup old release container
                    docker rm -f fast-react-pizza-release 2>nul || echo No old container
                    
                    REM Start release container
                    docker run -d --name fast-react-pizza-release -p 3002:80 fast-react-pizza:v1.0.0
                    
                    REM Wait
                    ping 127.0.0.1 -n 11 >nul
                    
                    REM Verify
                    docker ps | findstr fast-react-pizza-release
                    
                    echo âœ… Release container running on http://localhost:3002
                '''
            }
        }
        
        stage('ğŸ”¥ Smoke Test') {
            steps {
                echo '========== STAGE 6: SMOKE TEST =========='
                bat '''
                    echo ğŸ§ª Testing release on http://localhost:3002
                    curl -f http://localhost:3002 || exit /b 1
                    
                    echo âœ… Release smoke test PASSED
                '''
            }
        }
        
        stage('ğŸ“¦ Archive Artifacts') {
            steps {
                echo '========== STAGE 7: ARCHIVE RELEASE ARTIFACTS =========='
                bat '''
                    echo Creating release archive...
                    
                    echo Release Build Report > release-v1.0.0.log
                    echo ==================== >> release-v1.0.0.log
                    echo Version: v1.0.0 >> release-v1.0. 0.log
                    echo Build Number: %BUILD_NUMBER% >> release-v1.0.0.log
                    echo Build Date: %DATE% %TIME% >> release-v1. 0.0.log
                    echo Docker Image: fast-react-pizza:v1.0.0 >> release-v1.0.0.log
                    echo Status: SUCCESS >> release-v1. 0.0.log
                    echo ==================== >> release-v1. 0.0.log
                    
                    REM Create release archive
                    docker save fast-react-pizza:v1.0.0 -o fast-react-pizza-v1.0.0.tar
                    
                    echo âœ… Release artifacts created
                    dir *.tar
                    dir *.log
                '''
                
                archiveArtifacts artifacts: '*.tar,*.log', allowEmptyArchive: false
            }
        }
        
        stage('ğŸ§¹ Cleanup') {
            steps {
                echo '========== STAGE 8: CLEANUP =========='
                bat '''
                    echo ğŸ§¹ Stopping release container...
                    docker stop fast-react-pizza-release || echo Already stopped
                    docker rm fast-react-pizza-release || echo Already removed
                    
                    echo âœ… Cleanup complete
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ…âœ…âœ… RELEASE v1.0.0 PIPELINE PASSED âœ…âœ…âœ…'
            echo 'ğŸ“¦ Release artifacts archived successfully'
            echo 'ğŸ³ Docker image: fast-react-pizza:v1.0.0'
        }
        failure {
            echo 'âŒâŒâŒ RELEASE PIPELINE FAILED âŒâŒâŒ'
        }
        always {
            cleanWs()
        }
    }
}