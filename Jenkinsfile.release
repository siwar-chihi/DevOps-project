pipeline {
    agent any
    
    environment {
        APP_NAME = 'fast-react-pizza'
        VERSION_TAG = "${env.TAG_NAME ?: 'v1.0.0'}"
        DOCKER_IMAGE = "${APP_NAME}-${VERSION_TAG}"
        CONTAINER_NAME = "${APP_NAME}-release-${env.BUILD_NUMBER}"
        PORT = '3003'
    }
    
    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo '========== STAGE 1: CHECKOUT =========='
                checkout scm
                bat '''
                    echo âœ… Checked out tag: %VERSION_TAG%
                    git describe --tags || echo No tag found
                    git log -1 --oneline
                '''
            }
        }
        
        stage('âš™ï¸ Setup') {
            steps {
                echo '========== STAGE 2: SETUP =========='
                bat '''
                    echo ğŸ·ï¸  Release Version: %VERSION_TAG%
                    node --version
                    npm --version
                    docker --version
                '''
            }
        }
        
        stage('ğŸ”¨ Build') {
            steps {
                echo '========== STAGE 3: BUILD =========='
                bat '''
                    echo ğŸ“¦ Installing production dependencies... 
                    call npm ci
                    
                    REM Linter skipped for release build
                    
                    echo âœ… Dependencies installed
                '''
            }
        }
        
        stage('ğŸ³ Docker Build') {
            steps {
                echo '========== STAGE 4: DOCKER BUILD =========='
                bat '''
                    echo ğŸ³ Building versioned image: %DOCKER_IMAGE%
                    docker build -t %DOCKER_IMAGE% -t %APP_NAME%-latest .
                    
                    echo âœ… Image built and tagged
                    docker images | findstr %APP_NAME%
                '''
            }
        }
        
        stage('ğŸš€ Run') {
            steps {
                echo '========== STAGE 5: RUN CONTAINER =========='
                bat '''
                    REM Cleanup old container
                    docker rm -f %CONTAINER_NAME% 2>nul || echo No old container
                    
                    REM Start new container
                    docker run -d --name %CONTAINER_NAME% -p %PORT%:80 -e APP_VERSION=%VERSION_TAG% %DOCKER_IMAGE%
                    
                    REM Wait 10 seconds
                    ping 127.0.0.1 -n 11 >nul
                    
                    REM Verify
                    docker ps | findstr %CONTAINER_NAME%
                    
                    echo âœ… Container running on http://localhost:%PORT%
                '''
            }
        }
        
        stage('ğŸ”¥ Smoke Test') {
            steps {
                echo '========== STAGE 6: SMOKE TESTS =========='
                bat '''
                    echo ğŸ§ª Testing application on http://localhost:%PORT%
                    curl -f http://localhost:%PORT% || exit /b 1
                    
                    echo âœ… Smoke test PASSED
                '''
            }
        }
        
        stage('ğŸ“¦ Archive Artifacts') {
            steps {
                echo '========== STAGE 7: ARCHIVE RELEASE ARTIFACTS =========='
                bat '''
                    REM Create artifacts directory
                    if not exist artifacts\\release-%VERSION_TAG% mkdir artifacts\\release-%VERSION_TAG%
                    
                    REM Create release notes
                    echo ==================== > artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES. txt
                    echo RELEASE BUILD REPORT >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES. txt
                    echo ==================== >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo.  >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES. txt
                    echo Version: %VERSION_TAG% >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo Build Number: %BUILD_NUMBER% >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo Build Date: %date% %time% >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES. txt
                    echo Docker Image: %DOCKER_IMAGE% >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES. txt
                    echo Container: %CONTAINER_NAME% >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo Port: %PORT% >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo Status: PRODUCTION READY >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo. >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    echo ==================== >> artifacts\\release-%VERSION_TAG%\\RELEASE-NOTES.txt
                    
                    REM Export container logs
                    docker logs %CONTAINER_NAME% > artifacts\\release-%VERSION_TAG%\\container-logs.txt 2>&1
                    
                    REM Export image details
                    docker inspect %DOCKER_IMAGE% > artifacts\\release-%VERSION_TAG%\\image-details.json
                    
                    REM Save Docker image as tar
                    echo Saving Docker image to tar file...
                    docker save %DOCKER_IMAGE% -o artifacts\\release-%VERSION_TAG%\\%APP_NAME%-%VERSION_TAG%.tar
                    
                    REM List artifacts
                    echo. 
                    echo ğŸ“¦ Artifacts created:
                    dir artifacts\\release-%VERSION_TAG%
                    
                    echo âœ… Artifacts archived
                '''
                archiveArtifacts artifacts: 'artifacts/**/*', allowEmptyArchive: false
            }
        }
        
        stage('ğŸ§¹ Cleanup') {
            steps {
                echo '========== STAGE 8: CLEANUP =========='
                bat '''
                    echo ğŸ§¹ Cleaning up... 
                    
                    REM Stop and remove container
                    docker stop %CONTAINER_NAME% 2>nul || echo Container already stopped
                    docker rm %CONTAINER_NAME% 2>nul || echo Container already removed
                    
                    echo âœ… Keeping Docker image %DOCKER_IMAGE% for deployment
                    echo â„¹ï¸  Image available for: docker run -d -p 3003:80 %DOCKER_IMAGE%
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ…âœ…âœ… RELEASE %VERSION_TAG% PIPELINE PASSED âœ…âœ…âœ…'
            echo 'ğŸ“¦ Artifacts: artifacts/release-%VERSION_TAG%/'
            echo 'ğŸ³ Docker Image: %DOCKER_IMAGE%'
            echo 'ğŸ‰ Ready for production deployment!'
        }
        failure {
            echo 'âŒâŒâŒ RELEASE PIPELINE FAILED âŒâŒâŒ'
            echo 'Check console output for errors'
        }
        always {
            cleanWs()
        }
    }
}
